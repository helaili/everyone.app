# AZURE_CREDENTIALS obtained with `az ad sp create-for-rbac --name "everyone.app" --sdk-auth --role contributor --scopes /subscriptions/xxxxx/resourceGroups/everyone.app`
name: Publishing

on:
  push:
    branches: [ main ]
env:
  CONTAINER_NAME: everyone-app
  RESOURCE_GROUP: everyone.app
  APP_SERVICE_PLAN: east-us-linux-dev
  WEBAPP_NAME: everyone-app-qa
  DOCKER_REGISTRY_URL: docker.pkg.github.com
  DOCKER_USERNAME: <token>
  DOCKER_PASSWORD: ${{secrets.GITHUB_TOKEN}}

jobs:
  build_image:
    name: Build the docker image
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
    - name: Build the Docker image
      run: docker build . --file Dockerfile --tag $DOCKER_REGISTRY_URL/$GITHUB_REPOSITORY/$CONTAINER_NAME:$GITHUB_SHA
    - name: GHPR Docker Login
      uses: docker/login-action@v1
      with:
        registry: ${{ env.DOCKER_REGISTRY_URL }}
        username: ${{ env.DOCKER_USERNAME }}
        password: ${{ env.DOCKER_PASSWORD }}
    - name: Publish Docker image
      id: container_publish
      run: |
        docker push $DOCKER_REGISTRY_URL/$GITHUB_REPOSITORY/$CONTAINER_NAME:$GITHUB_SHA
  
  azure_create_app:
    name: Create the app on Azure
    runs-on: ubuntu-latest
    
    environment: 
      name: 'qa'

    steps:
    - name: Login to Azure
      uses: azure/login@v1
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}

    - name: Create the review app
      run: |
        az webapp create --resource-group $RESOURCE_GROUP --plan $APP_SERVICE_PLAN --name $WEBAPP_NAME --deployment-container-image-name $DOCKER_REGISTRY_URL/$GITHUB_REPOSITORY/$CONTAINER_NAME:$GITHUB_SHA
        az webapp config container set --resource-group $RESOURCE_GROUP --name $WEBAPP_NAME --docker-registry-server-password $DOCKER_PASSWORD --docker-registry-server-user $DOCKER_USERNAME --docker-registry-server-url $DOCKER_REGISTRY_URL
        az webapp update -g $RESOURCE_GROUP -n $WEBAPP_NAME_PREFIX-$GITHUB_SHA --set tags.ref=$GITHUB_REF tags.type=review
  

